name: 'Publish application'
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - uses: actions/checkout@v2

      # Install .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x

      # Run tests
      - name: Test
        run: dotnet test

      # Generate the website
      - name: Publish
        run: dotnet publish Blazor.Ionic.Demo/Blazor.Ionic.Demo.csproj --configuration Release

      # Edit the index.html file
      - name: Update index.html
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: jacobtomlinson/gha-find-replace@master
        with:
          find: <base href="/" />
          replace: <base href="/Blazor.Ionic/"/>
          include: index.html
          
      - name: Add 404 spa fix for github pages
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: finnp/create-file-action@master
        env:
          FILE_NAME: Blazor.Ionic.Demo/bin/Release/netstandard2.1/publish/wwwroot/404.html
          FILE_BASE64: PCFET0NUWVBFIGh0bWw+PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiPjx0aXRsZT5TaW5nbGUgUGFnZSBBcHBzIGZvciBHaXRIdWIgUGFnZXM8L3RpdGxlPiA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+dmFyIHBhdGhTZWdtZW50c1RvS2VlcD0xO3ZhciBsPXdpbmRvdy5sb2NhdGlvbjtsLnJlcGxhY2UobC5wcm90b2NvbCsnLy8nK2wuaG9zdG5hbWUrKGwucG9ydD8nOicrbC5wb3J0OicnKStsLnBhdGhuYW1lLnNwbGl0KCcvJykuc2xpY2UoMCwxK3BhdGhTZWdtZW50c1RvS2VlcCkuam9pbignLycpKycvJytsLnBhdGhuYW1lLnNsaWNlKDEpLnNwbGl0KCcvJykuc2xpY2UocGF0aFNlZ21lbnRzVG9LZWVwKS5qb2luKCcvJykucmVwbGFjZSgvJi9nLCd+YW5kficpKyhsLnNlYXJjaD8nJicrbC5zZWFyY2guc2xpY2UoMSkucmVwbGFjZSgvJi9nLCd+YW5kficpOicnKStsLmhhc2gpOzwvc2NyaXB0PiA8L2hlYWQ+PGJvZHk+PC9ib2R5PjwvaHRtbD4=
      # Publish the website
      - name: GitHub Pages action
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: peaceiris/actions-gh-pages@v3.6.1
        with:
          github_token: ${{ secrets.PUBLISH_TOKEN }}
          publish_branch: gh-pages
          publish_dir: Blazor.Ionic.Demo/bin/Release/netstandard2.1/publish/wwwroot
          allow_empty_commit: false
          keep_files: false
          force_orphan: true
      - name: Publish NuGet
        if: ${{ github.ref == 'refs/heads/master' }} # Publish only when the push is on master
        uses: brandedoutcast/publish-nuget@v2.5.5
        with:
          PROJECT_FILE_PATH: Blazor.Ionic/Blazor.Ionic.csproj
          NUGET_KEY: ${{secrets.NUGET_KEY}}
          PACKAGE_NAME: BlazorIonic
          INCLUDE_SYMBOLS: true
          VERSION_REGEX: ^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$
